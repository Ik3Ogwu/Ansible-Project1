- name: Install docker and config
    hosts: _development                                                  #"all" of our host machines
    become: true
    vars:
      aws_region: us-east-1                                           #AWS region
      ecr_registry: AKIA6GBMHPHS76CK7SG3.dkr.ecr.us-east-1.amazonaws.com          #ECR ID
    tasks:
 
    # we need to uninstall any existing docker files from the centos repo first.
    - name: Remove docker if installed from CentOS repo
      yum:
        name: "{{ item }}"
        state: absent # use correct state
      with_items:
        - docker
        - docker-client
        - docker-client-latest
        - docker-common
        - docker-latest
        - docker-latest-logrotate
        - docker-logrotate
        - docker-engine
 
    - name: Install yum utils
      yum:
        name: "{{ item }}"
        state: present # use correct state
      with_items:
        - yum-utils # install yum utils
        - device-mapper-persistent-data
        - lmv2
        - unzip
 
    - name: Add Docker repo
      get_url:
        url: https://download.docker.com/linux/centos/docker-ce.repo
        dest: /etc/yum.repos.d/docker-ce.repo
 
    - name: Install Docker
      package:
        name: docker-ce
        state: latest
 
    - name: Install pip
      package:
        name: python3-pip # use required package for pip
        state: present # use correct state
        update_cache: true
 
    - name: Install docker sdk
      pip:
        name: docker
 
    - name: Add user ec2-user to docker group
      user:
        name : ec2-user
        group : docker
        append : yes
 
    - name: Start Docker service
      service:
        name : docker
        state : started
        enabled : yes 
 
    - name: install aws cli
      get_url:
        url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
        dest: /home/ec2-user/awscliv2.zip
 
    - name: unzip zip file
      unarchive:
        src: /home/ec2-user/awscliv2.zip
        dest: /home/ec2-user
        remote_src: True
 
    - name: run the installer
      command:
      args:
        cmd: ./aws/install
        creates: /usr/local/bin/aws
 
    - name: log in to AWS ec2-user
      shell: |
        export PATH = /usr/local/bin:$PATH
        source ~/.bash_profile
        aws ecr get-login-password --region {{ aws_region }} | docker login --username AWS --password-stdin {{ ecr_registry }}